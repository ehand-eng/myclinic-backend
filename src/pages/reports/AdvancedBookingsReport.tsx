import React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useNavigate } from 'react-router-dom';\nimport { useToast } from '@/hooks/use-toast';\nimport { CalendarIcon, FileTextIcon, PrinterIcon, BarChart3Icon } from 'lucide-react';\nimport Header from '@/components/Header';\nimport Footer from '@/components/Footer';\nimport api from '@/lib/axios';\nimport { exportAdvancedReportToPDF } from '@/lib/pdfExport';\n\ninterface Doctor {\n  _id: string;\n  name: string;\n  specialization: string;\n}\n\ninterface Dispensary {\n  _id: string;\n  name: string;\n  address: string;\n}\n\ninterface TimeSlot {\n  slot: string;\n  isAvailable: boolean;\n}\n\ninterface BookingReportData {\n  id: string;\n  timeSlot: string;\n  patientName: string;\n  patientPhone: string;\n  status: string;\n  doctorName: string;\n  dispensaryName: string;\n  bookingDate: string;\n  checkedInTime?: string;\n  completedTime?: string;\n}\n\ninterface ReportSummary {\n  total: number;\n  completed: number;\n  cancelled: number;\n  noShow: number;\n  bookings: BookingReportData[];\n}\n\nconst AdvancedBookingsReport = () => {\n  const navigate = useNavigate();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(true);\n  const [currentUser, setCurrentUser] = useState<any>(null);\n  const [isGeneratingReport, setIsGeneratingReport] = useState(false);\n  \n  // Form state\n  const [startDate, setStartDate] = useState('');\n  const [endDate, setEndDate] = useState('');\n  const [selectedDispensary, setSelectedDispensary] = useState('');\n  const [selectedDoctor, setSelectedDoctor] = useState('');\n  const [selectedTimeSlot, setSelectedTimeSlot] = useState('');\n  \n  // Data state\n  const [dispensaries, setDispensaries] = useState<Dispensary[]>([]);\n  const [doctors, setDoctors] = useState<Doctor[]>([]);\n  const [timeSlots, setTimeSlots] = useState<TimeSlot[]>([]);\n  const [reportData, setReportData] = useState<ReportSummary | null>(null);\n  \n  const isSuperAdmin = currentUser?.role?.toLowerCase() === 'super admin' || currentUser?.role?.toLowerCase() === 'super-admin';\n  const isDispensaryRole = currentUser?.role?.toLowerCase().includes('dispensary') || currentUser?.role?.toLowerCase().includes('hospital');\n\n  useEffect(() => {\n    const checkAuthAndLoadData = async () => {\n      setIsLoading(true);\n      \n      const token = localStorage.getItem('auth_token');\n      const userStr = localStorage.getItem('current_user');\n      const user = userStr ? JSON.parse(userStr) : null;\n      \n      if (!token || !user) {\n        toast({\n          title: \"Authentication required\",\n          description: \"Please log in to access reports\",\n          variant: \"destructive\"\n        });\n        navigate('/login');\n        return;\n      }\n      \n      // Check if user has permission to view reports\n      const allowedRoles = ['super admin', 'super-admin', 'dispensary admin', 'dispensary-admin', 'dispensary staff', 'dispensary-staff'];\n      const userRole = user.role?.toLowerCase().replace(/[-_]/g, '-') || '';\n      \n      if (!allowedRoles.some(role => role.replace(/[-_]/g, '-') === userRole)) {\n        toast({\n          title: \"Access denied\",\n          description: \"You don't have permission to view reports\",\n          variant: \"destructive\"\n        });\n        navigate('/admin/dashboard');\n        return;\n      }\n      \n      setCurrentUser(user);\n      \n      // Set default date range (last 30 days)\n      const today = new Date();\n      const thirtyDaysAgo = new Date();\n      thirtyDaysAgo.setDate(today.getDate() - 30);\n      \n      setStartDate(thirtyDaysAgo.toISOString().split('T')[0]);\n      setEndDate(today.toISOString().split('T')[0]);\n      \n      // Load dispensaries\n      await loadDispensaries();\n      \n      setIsLoading(false);\n    };\n    \n    checkAuthAndLoadData();\n  }, [navigate, toast]);\n\n  const loadDispensaries = async () => {\n    try {\n      const response = await api.get('/dispensaries');\n      setDispensaries(response.data);\n    } catch (error) {\n      console.error('Error loading dispensaries:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to load dispensaries\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  const loadDoctors = async (dispensaryId: string) => {\n    try {\n      const response = await api.get(`/doctor-dispensaries/dispensary/${dispensaryId}`);\n      setDoctors(response.data.map((dd: any) => dd.doctorId));\n    } catch (error) {\n      console.error('Error loading doctors:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to load doctors\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  const loadTimeSlots = async (doctorId: string, dispensaryId: string) => {\n    try {\n      const response = await api.get(`/doctor-dispensaries/timeslots/${doctorId}/${dispensaryId}`);\n      setTimeSlots(response.data.timeSlots || []);\n    } catch (error) {\n      console.error('Error loading time slots:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to load time slots\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  const handleDispensaryChange = async (dispensaryId: string) => {\n    setSelectedDispensary(dispensaryId);\n    setSelectedDoctor('');\n    setSelectedTimeSlot('');\n    setDoctors([]);\n    setTimeSlots([]);\n    \n    if (dispensaryId) {\n      await loadDoctors(dispensaryId);\n    }\n  };\n\n  const handleDoctorChange = async (doctorId: string) => {\n    setSelectedDoctor(doctorId);\n    setSelectedTimeSlot('');\n    setTimeSlots([]);\n    \n    if (doctorId && selectedDispensary) {\n      await loadTimeSlots(doctorId, selectedDispensary);\n    }\n  };\n\n  const generateReport = async () => {\n    if (!startDate || !endDate) {\n      toast({\n        title: \"Date range required\",\n        description: \"Please select both start and end dates\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (new Date(startDate) > new Date(endDate)) {\n      toast({\n        title: \"Invalid date range\",\n        description: \"Start date must be before end date\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // For dispensary roles, all fields are required\n    if (isDispensaryRole) {\n      if (!selectedDispensary) {\n        toast({\n          title: \"Dispensary required\",\n          description: \"Please select a dispensary\",\n          variant: \"destructive\"\n        });\n        return;\n      }\n      \n      if (!selectedDoctor) {\n        toast({\n          title: \"Doctor required\",\n          description: \"Please select a doctor\",\n          variant: \"destructive\"\n        });\n        return;\n      }\n      \n      if (!selectedTimeSlot) {\n        toast({\n          title: \"Time slot required\",\n          description: \"Please select a time slot\",\n          variant: \"destructive\"\n        });\n        return;\n      }\n    }\n\n    setIsGeneratingReport(true);\n    \n    try {\n      const params = new URLSearchParams({\n        startDate,\n        endDate\n      });\n      \n      if (selectedDispensary) params.append('dispensaryId', selectedDispensary);\n      if (selectedDoctor) params.append('doctorId', selectedDoctor);\n      if (selectedTimeSlot) params.append('timeSlot', selectedTimeSlot);\n      \n      const response = await api.get(`/reports/advance-bookings?${params}`);\n      setReportData(response.data);\n      \n      toast({\n        title: \"Report generated\",\n        description: `Found ${response.data.total} bookings for the selected criteria`\n      });\n    } catch (error: any) {\n      console.error('Error generating report:', error);\n      toast({\n        title: \"Error\",\n        description: error.response?.data?.message || \"Failed to generate report\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsGeneratingReport(false);\n    }\n  };\n\n  const exportToPDF = () => {\n    if (!reportData) {\n      toast({\n        title: \"No data to export\",\n        description: \"Please generate a report first\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const selectedDispensaryName = dispensaries.find(d => d._id === selectedDispensary)?.name || 'All Dispensaries';\n    const selectedDoctorName = doctors.find(d => d._id === selectedDoctor)?.name || 'All Doctors';\n    \n    exportAdvancedReportToPDF(reportData, {\n      title: 'Advanced Bookings Report',\n      dateRange: `${startDate} to ${endDate}`,\n      dispensary: selectedDispensary ? selectedDispensaryName : undefined,\n      doctor: selectedDoctor ? selectedDoctorName : undefined,\n      timeSlot: selectedTimeSlot || undefined,\n      currentUser\n    });\n    \n    toast({\n      title: \"PDF exported\",\n      description: \"Report has been downloaded as PDF\",\n    });\n  };\n\n  const printReport = () => {\n    if (!reportData) {\n      toast({\n        title: \"No data to print\",\n        description: \"Please generate a report first\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    window.print();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex flex-col min-h-screen\">\n        <Header />\n        <main className=\"flex-grow flex items-center justify-center\">\n          <p className=\"text-xl\">Loading...</p>\n        </main>\n        <Footer />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col min-h-screen\">\n      <Header />\n      \n      <main className=\"flex-grow container mx-auto px-4 py-8\">\n        <div className=\"flex justify-between items-center mb-8\">\n          <div>\n            <h1 className=\"text-3xl font-bold\">Advanced Bookings Report</h1>\n            <p className=\"text-gray-500\">Generate detailed booking reports with date range and advanced filters</p>\n          </div>\n          \n          <Button onClick={() => navigate('/admin/dashboard')}>\n            Back to Dashboard\n          </Button>\n        </div>\n\n        {/* Report Parameters */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <CalendarIcon className=\"h-5 w-5\" />\n              Report Parameters\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {/* Date Range */}\n              <div className=\"md:col-span-2 grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"startDate\">Start Date *</Label>\n                  <Input\n                    id=\"startDate\"\n                    type=\"date\"\n                    value={startDate}\n                    onChange={(e) => setStartDate(e.target.value)}\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"endDate\">End Date *</Label>\n                  <Input\n                    id=\"endDate\"\n                    type=\"date\"\n                    value={endDate}\n                    onChange={(e) => setEndDate(e.target.value)}\n                  />\n                </div>\n              </div>\n              \n              {/* Dispensary Selection */}\n              <div>\n                <Label htmlFor=\"dispensary\">\n                  Dispensary {isDispensaryRole ? '*' : '(Optional)'}\n                </Label>\n                <Select value={selectedDispensary} onValueChange={handleDispensaryChange}>\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select dispensary\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {isSuperAdmin && <SelectItem value=\"\">All Dispensaries</SelectItem>}\n                    {dispensaries.map((dispensary) => (\n                      <SelectItem key={dispensary._id} value={dispensary._id}>\n                        {dispensary.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              {/* Doctor Selection */}\n              <div>\n                <Label htmlFor=\"doctor\">\n                  Doctor {isDispensaryRole ? '*' : '(Optional)'}\n                </Label>\n                <Select \n                  value={selectedDoctor} \n                  onValueChange={handleDoctorChange}\n                  disabled={!selectedDispensary}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select doctor\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {isSuperAdmin && <SelectItem value=\"\">All Doctors</SelectItem>}\n                    {doctors.map((doctor) => (\n                      <SelectItem key={doctor._id} value={doctor._id}>\n                        {doctor.name} - {doctor.specialization}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              {/* Time Slot Selection */}\n              <div>\n                <Label htmlFor=\"timeSlot\">\n                  Time Slot {isDispensaryRole ? '*' : '(Optional)'}\n                </Label>\n                <Select \n                  value={selectedTimeSlot} \n                  onValueChange={setSelectedTimeSlot}\n                  disabled={!selectedDoctor || !selectedDispensary}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select time slot\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {isSuperAdmin && <SelectItem value=\"\">All Time Slots</SelectItem>}\n                    {timeSlots.map((slot) => (\n                      <SelectItem key={slot.slot} value={slot.slot}>\n                        {slot.slot}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            {/* Role-specific instructions */}\n            {isDispensaryRole && (\n              <div className=\"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg\">\n                <p className=\"text-sm text-blue-800\">\n                  <strong>Note:</strong> All fields marked with * are required for your role.\n                </p>\n              </div>\n            )}\n            \n            <div className=\"flex gap-2 mt-6\">\n              <Button \n                onClick={generateReport} \n                disabled={isGeneratingReport}\n                className=\"bg-medical-600 hover:bg-medical-700\"\n              >\n                {isGeneratingReport ? 'Generating...' : 'Generate Report'}\n              </Button>\n              \n              {reportData && (\n                <>\n                  <Button onClick={exportToPDF} variant=\"outline\">\n                    <FileTextIcon className=\"h-4 w-4 mr-2\" />\n                    Export PDF\n                  </Button>\n                  <Button onClick={printReport} variant=\"outline\">\n                    <PrinterIcon className=\"h-4 w-4 mr-2\" />\n                    Print\n                  </Button>\n                </>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Report Summary */}\n        {reportData && (\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                  Total Bookings\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold\">{reportData.total}</div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {startDate} to {endDate}\n                </p>\n              </CardContent>\n            </Card>\n            \n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                  Completed\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-green-600\">{reportData.completed}</div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {reportData.total > 0 ? Math.round((reportData.completed / reportData.total) * 100) : 0}% completion rate\n                </p>\n              </CardContent>\n            </Card>\n            \n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                  Cancelled\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-red-600\">{reportData.cancelled}</div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {reportData.total > 0 ? Math.round((reportData.cancelled / reportData.total) * 100) : 0}% cancellation rate\n                </p>\n              </CardContent>\n            </Card>\n            \n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                  No Show\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-yellow-600\">{reportData.noShow}</div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {reportData.total > 0 ? Math.round((reportData.noShow / reportData.total) * 100) : 0}% no-show rate\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {/* Bookings Table */}\n        {reportData && reportData.bookings.length > 0 && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <BarChart3Icon className=\"h-5 w-5\" />\n                Booking Details ({reportData.bookings.length} bookings)\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse border border-gray-300\">\n                  <thead>\n                    <tr className=\"bg-gray-50\">\n                      <th className=\"border border-gray-300 px-4 py-2 text-left\">Date</th>\n                      <th className=\"border border-gray-300 px-4 py-2 text-left\">Time Slot</th>\n                      <th className=\"border border-gray-300 px-4 py-2 text-left\">Patient Name</th>\n                      <th className=\"border border-gray-300 px-4 py-2 text-left\">Phone</th>\n                      <th className=\"border border-gray-300 px-4 py-2 text-left\">Doctor</th>\n                      <th className=\"border border-gray-300 px-4 py-2 text-left\">Dispensary</th>\n                      <th className=\"border border-gray-300 px-4 py-2 text-left\">Status</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {reportData.bookings.map((booking) => (\n                      <tr key={booking.id} className=\"hover:bg-gray-50\">\n                        <td className=\"border border-gray-300 px-4 py-2\">\n                          {new Date(booking.bookingDate).toLocaleDateString()}\n                        </td>\n                        <td className=\"border border-gray-300 px-4 py-2\">{booking.timeSlot}</td>\n                        <td className=\"border border-gray-300 px-4 py-2\">{booking.patientName}</td>\n                        <td className=\"border border-gray-300 px-4 py-2\">{booking.patientPhone}</td>\n                        <td className=\"border border-gray-300 px-4 py-2\">{booking.doctorName}</td>\n                        <td className=\"border border-gray-300 px-4 py-2\">{booking.dispensaryName}</td>\n                        <td className=\"border border-gray-300 px-4 py-2\">\n                          <span className={`px-2 py-1 rounded text-xs ${\n                            booking.status === 'completed' ? 'bg-green-100 text-green-800' :\n                            booking.status === 'cancelled' ? 'bg-red-100 text-red-800' :\n                            booking.status === 'no_show' ? 'bg-yellow-100 text-yellow-800' :\n                            'bg-blue-100 text-blue-800'\n                          }`}>\n                            {booking.status}\n                          </span>\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {reportData && reportData.bookings.length === 0 && (\n          <Card>\n            <CardContent className=\"text-center py-12\">\n              <BarChart3Icon className=\"h-16 w-16 mx-auto text-gray-300 mb-4\" />\n              <h3 className=\"text-lg font-medium text-gray-600 mb-2\">No Bookings Found</h3>\n              <p className=\"text-gray-500\">No bookings match the selected criteria for this date range.</p>\n            </CardContent>\n          </Card>\n        )}\n\n        {!reportData && (\n          <Card>\n            <CardContent className=\"text-center py-12\">\n              <BarChart3Icon className=\"h-16 w-16 mx-auto text-gray-300 mb-4\" />\n              <h3 className=\"text-lg font-medium text-gray-600 mb-2\">No Report Generated</h3>\n              <p className=\"text-gray-500\">Select your criteria and click \"Generate Report\" to view advanced booking data.</p>\n            </CardContent>\n          </Card>\n        )}\n      </main>\n      \n      <Footer />\n    </div>\n  );\n};\n\nexport default AdvancedBookingsReport;